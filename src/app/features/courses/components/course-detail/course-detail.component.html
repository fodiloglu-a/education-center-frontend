<div class="course-detail-container">
    <!-- Loading Spinner -->
    <app-loading-spinner *ngIf="isLoading"></app-loading-spinner>

    <!-- Error Messages -->
    <app-alert-dialog
            *ngIf="errorMessage"
            [message]="errorMessage"
            type="error"
            [autoClose]="true"
            (closed)="clearMessages()">
    </app-alert-dialog>

    <!-- Success Messages -->
    <app-alert-dialog
            *ngIf="successMessage"
            [message]="successMessage"
            type="success"
            [autoClose]="true"
            (closed)="clearMessages()">
    </app-alert-dialog>

    <!-- Payment Checkout Container -->
    <div class="payment-container" [class.show]="showLiqpayContainer">
        <!-- Loading State -->
        <div *ngIf="showLiqpayContainer && isProcessingPayment" class="liqpay-loading-box">
            <div class="loading-content">
                <i class="fas fa-spinner fa-spin liqpay-spinner"></i>
                <p class="liqpay-loading-text">{{ 'LIQPAY_LOADING_FORM' | translate }}</p>
            </div>
        </div>

        <!-- LiqPay Container with Close Button -->
        <div *ngIf="showLiqpayContainer && !isProcessingPayment" class="liqpay-wrapper">
            <div class="liqpay-header">
                <h3 class="liqpay-title">{{ 'PAYMENT_FORM' | translate }}</h3>
                <button
                        class="close-payment-btn"
                        (click)="closeLiqPayContainer()"
                        type="button"
                        aria-label="Close payment form">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Actual LiqPay Embed Container -->
            <div id="liqpay_checkout" class="liqpay-embed-container"></div>

            <div class="liqpay-footer">
                <p class="payment-security-note">
                    <i class="fas fa-shield-alt"></i>
                    {{ 'SECURE_PAYMENT_NOTE' | translate }}
                </p>
            </div>
        </div>
    </div>

    <!-- Course Content -->
    <div class="course-content-wrapper" *ngIf="!isLoading && course">

        <!-- Course Header -->
        <div class="course-header">
            <div class="course-image-container">
                <img
                        [src]="course.imageUrl"
                        [alt]="course.title"
                        class="course-hero-image"
                        onerror="this.onerror=null;this.src='https://placehold.co/800x450/C3AD90/3D2010?text=Course+Image';" />

                <!-- Course Status Badges -->
                <div class="course-badges">
                    <span class="category-badge">
                        {{ getCategoryTranslation(course.category) }}
                    </span>
                    <span class="level-badge" [class]="'level-' + course.level.toLowerCase()">
                        {{ getLevelTranslation(course.level) }}
                    </span>
                    <span *ngIf="isCourseDetailsResponse(course) && course.certificateAvailable" class="certificate-badge">
                        <i class="fas fa-certificate"></i>
                        {{ 'CERTIFICATE_AVAILABLE' | translate }}
                    </span>
                </div>
            </div>

            <div class="course-info">
                <h1 class="course-title">{{ course.title }}</h1>
                <p class="course-description">{{ course.description }}</p>

                <!-- Course Meta Information -->
                <div class="course-meta">
                    <!-- Instructor Info -->

                    <div (click)="goToInsProfile()"   class="meta-item instructor-info">

                        <div class="meta-icon">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div class="meta-content">
                            <span class="meta-label">{{ 'INSTRUCTOR' | translate }}</span>
                            <a [routerLink]="['/instructors', course.instructorId]" class="meta-value instructor-name">{{ course.instructorName }}</a>
                        </div>
                    </div>

                    <!-- Rating and Reviews -->
                    <div class="meta-item rating-info" *ngIf="courseReviews.length > 0">
                        <div class="meta-icon">
                            <i class="fas fa-star-half-alt"></i>
                        </div>
                        <div class="meta-content">
                            <span class="meta-label">{{ 'RATING' | translate }}</span>
                            <div class="rating-display">
                                <div class="stars">
                                    <span *ngFor="let star of getStarArray(getAverageRating())" class="star" [class.filled]="star.filled" [class.half]="star.half">
                                        <i class="fas fa-star"></i>
                                    </span>
                                </div>
                                <span class="rating-text">{{ getAverageRating() | number:'1.1-1' }}</span>
                                <span class="review-count">({{ courseReviews.length }} {{ 'REVIEWS' | translate }})</span>
                            </div>
                        </div>
                    </div>

                    <!-- Student Count -->
                    <div class="meta-item student-info">
                        <div class="meta-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="meta-content">
                            <span class="meta-label">{{ 'ENROLLED_STUDENTS' | translate }}</span>
                            <span class="meta-value student-count">{{ course.enrollmentCount | number }} {{ 'STUDENTS' | translate }}</span>
                        </div>
                    </div>

                    <!-- Duration -->
                    <div class="meta-item duration-info" *ngIf="course.duration > 0">
                        <div class="meta-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="meta-content">
                            <span class="meta-label">{{ 'DURATION' | translate }}</span>
                            <span class="meta-value duration-text">{{ formatDuration(course.duration) }}</span>
                        </div>
                    </div>

                    <!-- Language -->
                    <div class="meta-item language-info">
                        <div class="meta-icon">
                            <i class="fas fa-globe"></i>
                        </div>
                        <div class="meta-content">
                            <span class="meta-label">{{ 'LANGUAGE' | translate }}</span>
                            <span class="meta-value language-text">{{   course.language.toUpperCase() | translate }}</span>
                        </div>
                    </div>

                    <!-- Course Level (if available) -->
                    <div class="meta-item level-info" *ngIf="course.level">
                        <div class="meta-icon">
                            <i class="fas fa-signal"></i>
                        </div>
                        <div class="meta-content">
                            <span class="meta-label">{{ 'LEVEL' | translate }}</span>
                            <span class="meta-value level-text">{{  course.level.toUpperCase() | translate }}</span>
                        </div>
                    </div>

                    <!-- Last Updated (if available) -->
                    <div class="meta-item updated-info" *ngIf="course.updatedAt">
                        <div class="meta-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="meta-content">
                            <span class="meta-label">{{ 'LAST_UPDATED' | translate }}</span>
                            <span class="meta-value updated-text">{{ course.updatedAt | date:'MMM yyyy' }}</span>
                        </div>
                    </div>
                </div>

                <!-- Course Price -->
                <div class="course-price-section">
                    <span class="current-price">{{ formatPrice(course.price) }}</span>
                    <span *ngIf="course.price === 0" class="free-badge">{{ 'FREE' | translate }}</span>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="course-actions-wrapper">
            <!-- Purchase Button -->
            <button
                    *ngIf="shouldShowPurchaseButton()"
                    class="action-btn purchase-btn"
                    (click)="purchaseCourse()"
                    [disabled]="isLoading || showLiqpayContainer || isProcessingPayment">
                <i class="fas fa-shopping-cart" *ngIf="!isProcessingPayment"></i>
                <i class="fas fa-spinner fa-spin" *ngIf="isProcessingPayment"></i>
                <span>{{ isProcessingPayment ? ('PROCESSING' | translate) : ('BUY_NOW' | translate) }}</span>
                <span *ngIf="!isProcessingPayment"> - {{ formatPrice(course.price) }}</span>
            </button>

            <!-- Ücretsiz Kayıt Butonu -->
            <button
                    *ngIf="shouldShowEnrollButton()"
                    class="action-btn enroll-btn"
                    (click)="purchaseCourse()"
                    [disabled]="isLoading || showLiqpayContainer || isProcessingPayment">
                <i class="fas fa-graduation-cap" *ngIf="!isProcessingPayment"></i>
                <i class="fas fa-spinner fa-spin" *ngIf="isProcessingPayment"></i>
                <span>{{ isProcessingPayment ? ('PROCESSING' | translate) : ('ENROLL_FREE' | translate) }}</span>
            </button>

            <!-- Login Required Message -->
            <div class="login-required" *ngIf="!isLoggedIn && !isCourseOwner">
                <p class="login-message">{{ 'LOGIN_REQUIRED_TO_PURCHASE' | translate }}</p>
                <a routerLink="/auth/login" class="action-btn login-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>{{ 'LOGIN' | translate }}</span>
                </a>
            </div>

            <!-- Already Purchased Message -->
            <div class="purchased-message" *ngIf="hasPurchasedCourse && !isCourseOwner">
                <i class="fas fa-check-circle"></i>
                <span>{{ 'COURSE_PURCHASED' | translate }}</span>
            </div>

            <!-- Course Owner Message -->
            <div class="owner-message" *ngIf="isCourseOwner">
                <i class="fas fa-crown"></i>
                <span>{{ 'YOU_ARE_COURSE_OWNER' | translate }}</span>
            </div>

            <!-- Admin Actions -->
            <div class="admin-actions" *ngIf="canEditCourse()">
                <button class="action-btn edit-btn" (click)="navigateToCourseEdit()">
                    <i class="fas fa-edit"></i>
                    <span>{{ 'EDIT_COURSE' | translate }}</span>
                </button>

                <button class="action-btn publish-btn" (click)="togglePublishStatus()" [disabled]="isLoading">
                    <i class="fas" [class.fa-eye]="!course.published" [class.fa-eye-slash]="course.published"></i>
                    <span>{{ course.published ? ('UNPUBLISH_COURSE' | translate) : ('PUBLISH_COURSE' | translate) }}</span>
                </button>

                <button class="action-btn add-lesson-btn" (click)="navigateToAddLesson()">
                    <i class="fas fa-plus"></i>
                    <span>{{ 'ADD_LESSON' | translate }}</span>
                </button>

                <button class="action-btn delete-btn" (click)="deleteCourse()" [disabled]="isLoading">
                    <i class="fas fa-trash"></i>
                    <span>{{ 'DELETE_COURSE' | translate }}</span>
                </button>
            </div>
        </div>

        <!-- Course Content Sections -->
        <div class="course-sections">

            <!-- Description, Requirements, What You Will Learn, Target Audience -->
            <div class="content-section info-blocks">
                <div *ngIf="isCourseDetailsResponse(course) && course.description" class="content-block">
                    <h3 class="block-title">{{ 'DESCRIPTION' | translate }}</h3>
                    <p class="long-description">{{ course.description }}</p>
                </div>
                <div *ngIf="isCourseDetailsResponse(course) && hasRequirements()" class="content-block">
                    <h3 class="block-title">{{ 'REQUIREMENTS' | translate }}</h3>
                    <ul class="info-list">
                        <li *ngFor="let item of getCourseRequirements(); trackBy: trackByRequirementIndex">
                            <i class="fas fa-check-circle check-icon"></i>
                            <span class="info-text">{{ item }}</span>
                        </li>
                    </ul>
                </div>
                <div *ngIf="isCourseDetailsResponse(course) && hasWhatYouWillLearn()" class="content-block">
                    <h3 class="block-title">{{ 'WHAT_YOU_WILL_LEARN' | translate }}</h3>
                    <ul class="info-list">
                        <li *ngFor="let item of getCourseWhatYouWillLearn(); trackBy: trackByRequirementIndex">
                            <i class="fas fa-check-circle check-icon"></i>
                            <span class="info-text">{{ item }}</span>
                        </li>
                    </ul>
                </div>
                <div *ngIf="isCourseDetailsResponse(course) && hasTargetAudience()" class="content-block">
                    <h3 class="block-title">{{ 'TARGET_AUDIENCE' | translate }}</h3>
                    <ul class="info-list">
                        <li *ngFor="let item of getCourseTargetAudience(); trackBy: trackByRequirementIndex">
                            <i class="fas fa-check-circle check-icon"></i>
                            <span class="info-text">{{ item }}</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Lessons Section -->
            <div class="content-section lessons-section">
                <div class="section-header">
                    <h2 class="section-title">{{ 'COURSE_LESSONS' | translate }}</h2>
                    <span class="lesson-count" *ngIf="hasLessons()">{{ getCourseLessons().length }} {{ 'LESSONS' | translate }}</span>
                </div>

                <div class="lessons-list" *ngIf="hasLessons()">
                    <div
                            class="lesson-item"
                            *ngFor="let lesson of getCourseLessons(); let i = index; trackBy: trackByLessonId">

                        <div class="lesson-info">
                            <span class="lesson-number">{{ i + 1 }}</span>
                            <div class="lesson-details">
                                <h4 class="lesson-title">{{ lesson.title }}</h4>
                                <div class="lesson-meta">
                                    <span *ngIf="lesson.duration > 0" class="lesson-duration">
                                        <i class="fas fa-clock"></i>
                                        {{ formatDuration(lesson.duration) }}
                                    </span>
                                    <span *ngIf="lesson.preview" class="preview-badge">
                                        <i class="fas fa-eye"></i>
                                        {{ 'PREVIEW' | translate }}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="lesson-actions">
                            <a *ngIf="canAccessLesson(lesson)"
                               [routerLink]="['/courses', courseId, 'lessons', lesson.id]"
                               class="action-btn play-btn">
                                <i class="fas fa-play-circle"></i>
                                <span>{{ 'PLAY' | translate }}</span>
                            </a>
                            <button *ngIf="!canAccessLesson(lesson)" class="action-btn locked-btn" disabled>
                                <i class="fas fa-lock"></i>
                                <span>{{ 'LOCKED' | translate }}</span>
                            </button>

                            <!-- Admin lesson actions -->
                            <div class="admin-lesson-actions" *ngIf="canEditCourse()">
                                <button class="action-btn secondary-btn" (click)="editLesson(lesson.id)">
                                    <i class="fas fa-edit"></i>
                                    <span>{{ 'EDIT' | translate }}</span>
                                </button>
                                <button class="action-btn danger-btn" (click)="deleteLesson(lesson.id)">
                                    <i class="fas fa-trash"></i>
                                    <span>{{ 'DELETE' | translate }}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div *ngIf="!hasLessons()" class="no-lessons">
                    <i class="fas fa-video"></i>
                    <h3>{{ 'NO_LESSONS_YET' | translate }}</h3>
                    <p>{{ 'LESSONS_COMING_SOON' | translate }}</p>
                    <button *ngIf="canEditCourse()" class="action-btn add-lesson-btn" (click)="navigateToAddLesson()">
                        <i class="fas fa-plus"></i>
                        <span>{{ 'ADD_FIRST_LESSON' | translate }}</span>
                    </button>
                </div>
            </div>

            <!-- Reviews Section -->
            <div class="content-section reviews-section">
                <div class="section-header">
                    <h2 class="section-title">{{ 'COURSE_REVIEWS' | translate }}</h2>
                </div>

                <div class="review-summary" *ngIf="courseReviews.length > 0">
                    <div class="summary-rating-stars">
                        <span class="average-score">{{ getAverageRating() | number:'1.1-1' }}</span>
                        <div class="stars-large">
                            <i *ngFor="let star of getStarArray(getAverageRating())" class="fas fa-star" [class.filled]="star.filled" [class.half]="star.half"></i>
                        </div>
                    </div>
                    <span class="total-reviews">({{ courseReviews.length }} {{ 'REVIEWS_IN_TOTAL' | translate }})</span>
                </div>

                <div class="review-action-buttons">
                    <button *ngIf="canReview() && !userReview" class="action-btn primary-btn add-review-btn" (click)="toggleReviewForm()">
                        <i class="fas fa-plus-circle"></i>
                        <span>{{ 'ADD_REVIEW' | translate }}</span>
                    </button>
                    <button *ngIf="userReview" class="action-btn secondary-btn edit-review-btn" (click)="toggleReviewForm()">
                        <i class="fas fa-edit"></i>
                        <span>{{ 'EDIT_MY_REVIEW' | translate }}</span>
                    </button>
                </div>

                <div class="review-form-container" *ngIf="showReviewForm">
                    <form [formGroup]="reviewForm" (ngSubmit)="submitReview()" class="review-form">
                        <div class="form-group">
                            <label for="rating">{{ 'RATING' | translate }}</label>
                            <select id="rating" formControlName="rating" class="rating-select" [class.is-invalid]="rating?.invalid && (rating?.dirty || rating?.touched)">
                                <option value="5">5 {{ 'STARS' | translate }}</option>
                                <option value="4">4 {{ 'STARS' | translate }}</option>
                                <option value="3">3 {{ 'STARS' | translate }}</option>
                                <option value="2">2 {{ 'STARS' | translate }}</option>
                                <option value="1">1 {{ 'STAR' | translate }}</option>
                            </select>
                            <div *ngIf="rating?.invalid && (rating?.dirty || rating?.touched)" class="invalid-feedback">
                                {{ 'RATING_REQUIRED' | translate }}
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="comment">{{ 'COMMENT' | translate }}</label>
                            <textarea
                                    id="comment"
                                    formControlName="comment"
                                    class="comment-input"
                                    rows="4"
                                    [placeholder]="'COMMENT_PLACEHOLDER' | translate"
                                    [class.is-invalid]="comment?.invalid && (comment?.dirty || comment?.touched)">
                            </textarea>
                            <div *ngIf="comment?.invalid && (comment?.dirty || comment?.touched)" class="invalid-feedback">
                                {{ 'COMMENT_TOO_LONG' | translate }}
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="submit-btn" [disabled]="reviewForm.invalid || isSubmittingReview">
                                <i class="fas fa-save" *ngIf="!isSubmittingReview"></i>
                                <i class="fas fa-spinner fa-spin" *ngIf="isSubmittingReview"></i>
                                <span>{{ userReview ? ('UPDATE_REVIEW' | translate) : ('SUBMIT_REVIEW' | translate) }}</span>
                            </button>
                            <button type="button" class="cancel-btn" (click)="toggleReviewForm()" [disabled]="isSubmittingReview">
                                <span>{{ 'CANCEL' | translate }}</span>
                            </button>
                        </div>
                    </form>
                </div>

                <div class="review-list" *ngIf="courseReviews.length > 0">
                    <div class="review-item" *ngFor="let review of courseReviews; trackBy: trackByReviewId">
                        <div class="review-header">
                            <div class="reviewer-info">
                                <i class="fas fa-user-circle reviewer-avatar"></i>
                                <div class="reviewer-details">
                                    <span class="reviewer-name">{{ review.userName }}</span>
                                    <div class="review-rating-stars">
                                        <i *ngFor="let star of getStarArray(review.rating)" class="fas fa-star" [class.filled]="star.filled"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="review-meta">
                                <span class="review-date">{{ review.createdAt | date:'shortDate' }}</span>
                                <div class="review-actions" *ngIf="canModifyReview(review)">
                                    <button
                                            *ngIf="currentUser?.id === review.userId"
                                            class="action-btn secondary-btn"
                                            (click)="editReview(review.id)">
                                        <i class="fas fa-edit"></i>
                                        <span>{{ 'EDIT' | translate }}</span>
                                    </button>
                                    <button class="action-btn danger-btn" (click)="deleteReview(review.id)">
                                        <i class="fas fa-trash"></i>
                                        <span>{{ 'DELETE' | translate }}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <p class="review-comment" *ngIf="review.comment">{{ review.comment }}</p>
                    </div>
                </div>

                <div class="no-reviews" *ngIf="courseReviews.length === 0">
                    <i class="fas fa-comments"></i>
                    <h3>{{ 'NO_REVIEWS_YET' | translate }}</h3>
                    <p>{{ 'BE_FIRST_TO_REVIEW' | translate }}</p>
                    <button *ngIf="canReview()" class="action-btn primary-btn" (click)="toggleReviewForm()">
                        <i class="fas fa-plus-circle"></i>
                        <span>{{ 'ADD_FIRST_REVIEW' | translate }}</span>
                    </button>
                </div>

                <div class="review-login-required" *ngIf="!isLoggedIn">
                    <p>{{ 'LOGIN_REQUIRED_TO_REVIEW' | translate }}</p>
                    <a routerLink="/auth/login" class="action-btn login-btn">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>{{ 'LOGIN' | translate }}</span>
                    </a>
                </div>

                <div class="review-purchase-required" *ngIf="isLoggedIn && !canReview() && !isCourseOwner">
                    <p>{{ 'PURCHASE_REQUIRED_TO_REVIEW' | translate }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- No Course Found -->
    <div *ngIf="!isLoading && !course && !errorMessage" class="no-course-found">
        <i class="fas fa-exclamation-triangle"></i>
        <h2>{{ 'COURSE_NOT_FOUND' | translate }}</h2>
        <p>{{ 'COURSE_NOT_FOUND_MESSAGE' | translate }}</p>
        <button class="action-btn primary-btn" routerLink="/courses">
            <i class="fas fa-arrow-left"></i>
            <span>{{ 'BACK_TO_COURSES' | translate }}</span>
        </button>
    </div>
</div>